# Техническое задание

Реализовать на ESQL службу Перевод денег (CARD_TRANSFER), которая осуществляет перевод денег между двумя банковскими картами.

## Интерфейс Службы

Служба доступна для клиентов как классический веб-сервис, описанный WSDL, по адресу
хост_cервера:порт_сервера/CARD_TRANSFER
По запросу хост_cервера:порт_сервера/CARD_TRANSFER?wsdl, Служба должна выдавать клиенту свой WSDL.

Служба предоставляет две операции:
1. Дать поручение на перевод (POST_REQUEST). Поручение включает ID клиента (уникален внутри банка), номер мобильного телефона, сумму и для каждой карты: номер, владельца, срок действия. 
Согласно внутренним политикам банка, Поручение не может превышать 20000 руб, и Клиент не может отправить Поручений больше чем на 100000 руб. в течение суток. 
В ответ служба возвращает статус приема Поручения - принято, не принято и если возможно - уникальный идентификатор Поручения в Службе (GUID). 
2. Получить статус обработки Поручения (GET_REQUEST_STATUS). Запрос - GUID, ответ - статус обработки Поручения.

### Операция "Дать поручение на перевод" работает по алгоритму:

1. Проверить Поручение на соответствие формату. Если не соответствует - обработка ошибки, затем шаг 5.
2. Сформировать и присвоить Поручению GUID.
3. Зафиксировать факт запроса в таблице REQUEST_STATUS внутренней БД Службы. Внутренняя БД службы расположена на сервере Oracle. 
В таблице сохраняется GUID Поручения, идентификатор клиента, сумма, время и дата создания, статус Поручения, статус оповещения клиента. Начальный статус - ACCEPTED. Начальный статус оповещения клиента PENDING.
4. Проверить допустимость Поручения, вызвав Веб-сервис "Проверка допустимости перевода" службы "Процессинг банковских карт". 
Веб-сервис "Проверка допустимости перевода" описывается следующим WSDL (WSDL доработать, добавив осмысленные ограничения для формата полей, например, для номера карты; считать, что сервис реализован, эмулировать заглушкой). Веб-сервис имеет лимит по одному Переводу в 20000 руб и лимит в 50000 руб. в сутки по одной карте.
При недоступности Веб-сервиса, запрос следует направить повторно N раз с интервалом Y (настройки на bar-файле). После этого - обработка ошибки, затем шаг 5.
5. Если все ОК, ответить клиенту о том, что Поручение принято на обработку. 
Если ошибка на предыдущих шагах, ответить клиенту сообщением об ошибке и завершить обработку.
6. Послать WMQ запрос службе "Процессинг банковских карт" в очередь PROCESSING.IN. 
"Процессинг банковских карт" спустя несколько минут выдаст ответ о завершении или ошибке операции по переводу денег, прислав WMQ сообщение в очередь ответов, указанную в запросе. 
Формат запроса и ответа описывается XSD (разработать самостоятельно, добавив уместную проверку форматов полей).
Если "Процессинг банковских карт" не ответит на запрос в течение M минут, то обработка ошибки.
7. Зафиксировать факт ответа, обновив статус Поручения в таблице REQUEST_STATUS в PROCESSED (перевод прошел) или REJECTED (ошибка операции). 
При REJECTED нужно в таблицу REQUEST_REJECTED внести уникальный идентификатор Поручения в Службе, код ошибки и описание из ответа от Процессинга.
8. Оповестить клиента, отправив СМС об итоге операции, для чего вызвать синхронную операцию "Отправить пакет СМС" службы "Отправка СМС", который описывается следующим WSDL (WSDL доработать, добавив осмысленные ограничения; считать, что уже реализован, эмулировать заглушкой) - id в ответе соотв id SMS в запросе.
По договору с поставщиками данной службы, мы имеем право посылать им запросы не чаще чем раз в полминуты, объединяя запросы на отправку СМС в пакеты. 
Если СМС для клиента было успешно отправлено, то выставить статус оповещения клиента в таблице REQUEST_STATUS в DONE. 
Если СМС для клиента не было доставлено, то выставить статус оповещения клиента в таблице REQUEST_STATUS в ERROR и залогировать ошибку, послав сообщение c данными об ошибке в очередь TRANSFER.ТЕXT.ERROR. 
Служба "Отправка СМС" расположена за пределами сети банка и достаточно часто недоступна или перегружена. 
При недоступности службы, запрос следует направить повторно N раз. После этого - обработать ошибку, и продолжить попытки отправки запросов.


### Операция "Получить статус перевода" работает по алгоритму:

1. Проверить запрос на соответствие формату. Если не соответствует - обработка ошибки, затем шаг 3.
2. Найти статус перевода в таблице REQUEST_STATUS по уникальному идентификатору. Если не найден – обработка ошибки, затем шаг 3.
3. Вернуть статус перевода.
Если перевод не найден или произошла ошибка при обработке запроса, вернуть краткое описание ошибки.

### Логирование

Для каждой операции следует логировать (в скобках название стадий обработки): сообщение от клиента (IN) , сообщения направляемые в службы (INTREQ), ответы от служб (INTRES), ответы посылаемые клиенту (OUT). 
Логирования осуществляем, выкладывая сообщение в очередь, TRANSFER.LOG.<операция Службы>.<стадия обработки>, предварительно заполнив MQRFH2.usr заголовки: guid – guid запроса (если имеется).

### Обработка ошибок

Ошибки следует обрабатывать, выкладывая сообщение, вызвавшее ошибку в очередь, TRANSFER.ERRORS.<операция Службы>.<стадия обработки>, предварительно заполнив MQRFH2.usr заголовки: guid – guid запроса (если имеется), error – краткое описание ошибки, trace – содержимое ExceptionList, если есть. 
Если не специфицируется иное, следует прекратить обработку сообщения, вызвавшего ошибку. 